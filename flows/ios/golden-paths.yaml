# iOS Golden Paths Flow
# Tests critical user journeys through the app
#
# Run: maestro test flows/ios/golden-paths.yaml

appId: com.myamaka.AmakaFlowCompanion

onFlowError:
  - takeScreenshot: artifacts/screenshots/ios-golden-error

---

# ============================================
# SETUP - Clean state for deterministic tests
# ============================================

- launchApp:
    clearState: true
    stopApp: true
    arguments:
      UITEST_MODE: "true"
      UITEST_AUTH_SECRET: "${UITEST_AUTH_SECRET}"
      UITEST_USER_ID: "${UITEST_USER_ID:-test-user-123}"
      UITEST_USE_FIXTURES: "true"
      UITEST_FIXTURES: "amrap_10min,emom_strength,strength_block_w1"
      UITEST_SKIP_ONBOARDING: "true"
      UITEST_SKIP_APPLE_WATCH: "true"

# Dismiss any system dialogs (WorkoutKit authorization, notifications, etc.)
- waitForAnimationToEnd
- tapOn:
    text: "Don't Allow"
    optional: true
- tapOn:
    text: "Allow"
    optional: true

- extendedWaitUntil:
    visible:
      id: "home_screen"
    timeout: 15000

- assertNotVisible:
    id: "error_view"
    optional: true

- takeScreenshot: artifacts/screenshots/ios-golden-01-launch

# ============================================
# GOLDEN PATH 1: View Workouts
# ============================================

# Navigate to workouts tab via tab bar icon
# (text "Workouts" is ambiguous - appears in stats section too)
- tapOn:
    id: "figure.run"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "workouts_screen"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-02-workouts-list

# Tap first workout if list is not empty
# This is optional because test data may not exist
- tapOn:
    id: "workout_card_0"
    optional: true
    retryTapIfNoChange: true

- takeScreenshot: artifacts/screenshots/ios-golden-03-workout-detail

# Dismiss workout detail sheet (presented as modal, not navigation push)
# Optional because workout_card_0 tap is optional
- tapOn:
    id: "xmark"
    optional: true
- waitForAnimationToEnd

# ============================================
# GOLDEN PATH 2: Voice Workout
# ============================================

# Return to home first
- tapOn:
    id: "house.fill"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "home_screen"
    timeout: 10000

# Open voice workout - MUST work (core feature)
- tapOn:
    id: "voice_workout_button"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "voice_recording_view"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-04-voice-workout

# Verify microphone button is present - MUST exist
- assertVisible:
    id: "microphone_button"

- takeScreenshot: artifacts/screenshots/ios-golden-05-voice-ready

# Dismiss voice workout sheet (presented as modal with "Close" toolbar button)
- tapOn:
    text: "Close"
    retryTapIfNoChange: true
- waitForAnimationToEnd

# ============================================
# GOLDEN PATH 3: Activity History
# ============================================

# Navigate via More menu (History is in overflow with 6 tabs)
- tapOn:
    text: "More"
    retryTapIfNoChange: true

- tapOn:
    text: "History"
    retryTapIfNoChange: true

# Dismiss any API error dialogs (no backend in test mode)
- waitForAnimationToEnd
- tapOn:
    text: "OK"
    optional: true
- waitForAnimationToEnd

- extendedWaitUntil:
    visible:
      id: "history_screen"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-06-history

# Tap first completion if exists (optional - depends on test data)
- tapOn:
    id: "completion_card_0"
    optional: true
    retryTapIfNoChange: true

- takeScreenshot: artifacts/screenshots/ios-golden-07-completion-detail

# Dismiss completion detail sheet if it was opened (optional)
- tapOn:
    text: "Done"
    optional: true
- waitForAnimationToEnd

# ============================================
# GOLDEN PATH 4: Settings
# ============================================

# Navigate via More tab bar button (resets More navigation stack)
- tapOn:
    text: "More"
    retryTapIfNoChange: true

- tapOn:
    text: "Settings"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "settings_screen"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-08-settings

# Open voice transcription settings - MUST work
# Need to scroll down past Workout Device and Audio Cues sections
- scrollUntilVisible:
    element:
      text: "Transcription Settings"
    direction: DOWN
    timeout: 10000
- tapOn:
    text: "Transcription Settings"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "voice_settings_screen"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-09-voice-settings

# Dismiss voice settings sheet (presented as modal with "Done" toolbar button)
- tapOn:
    text: "Done"
    retryTapIfNoChange: true
- waitForAnimationToEnd

# ============================================
# FINAL STATE
# ============================================

# Return to home
- tapOn:
    id: "house.fill"
    retryTapIfNoChange: true

- extendedWaitUntil:
    visible:
      id: "home_screen"
    timeout: 10000

- takeScreenshot: artifacts/screenshots/ios-golden-10-complete

# Final health check - specific assertions
- assertVisible:
    id: "home_screen"
- assertVisible:
    id: "house.fill"
- assertVisible:
    id: "figure.run"
- assertNotVisible:
    id: "error_view"
    optional: true
