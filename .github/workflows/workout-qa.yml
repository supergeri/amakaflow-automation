name: Workout Import QA

on:
  schedule:
    # Nightly at 06:00 UTC (1am EST)
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/workout_import_qa.py'
      - 'scripts/test_workout_import_qa.py'
      - 'fixtures/workout-qa-urls.json'
      - '.github/workflows/workout-qa.yml'

# Required secrets (already set in repo):
#   KIMI_API_KEY              - Moonshot AI key for Kimi vision
#   TELEGRAM_BOT_TOKEN        - Telegram bot token for delivery
#   TELEGRAM_CHAT_ID          - David's Telegram chat ID
#   GH_PAT                    - GitHub PAT to checkout amakaflow-dev-workspace
#   SUPABASE_URL              - Supabase project URL
#   SUPABASE_ANON_KEY         - Supabase anon key
#   SUPABASE_SERVICE_ROLE_KEY - Supabase service role key
#   OPENAI_API_KEY            - OpenAI key (for app services)
#   ANTHROPIC_API_KEY         - Anthropic key (for app services)
#   APIFY_API_TOKEN           - Apify token (for workout ingestion)
#   CLERK_PUBLISHABLE_KEY     - Clerk publishable key (pk_test_...)
#   CLERK_SECRET_KEY          - Clerk secret key (sk_test_...)
#   CLERK_DOMAIN              - Clerk domain (xxx.clerk.accounts.dev)
#   DATABASE_URL              - Direct Postgres connection string for calendar-api
#   INTERNAL_API_KEY          - Internal service-to-service auth key
#   YT_TRANSCRIPT_API_TOKEN   - YouTube transcript API token (optional, can be blank)

jobs:
  qa:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout amakaflow-automation
        uses: actions/checkout@v4

      - name: Checkout amakaflow-dev-workspace
        uses: actions/checkout@v4
        with:
          repository: supergeri/amakaflow-dev-workspace
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace

      - name: Checkout amakaflow-ui
        uses: actions/checkout@v4
        with:
          repository: supergeri/amakaflow-ui
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace/amakaflow-ui

      - name: Checkout chat-api
        uses: actions/checkout@v4
        with:
          repository: supergeri/chat-api
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace/chat-api

      - name: Checkout mapper-api
        uses: actions/checkout@v4
        with:
          repository: supergeri/mapper-api
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace/mapper-api

      - name: Checkout calendar-api
        uses: actions/checkout@v4
        with:
          repository: supergeri/calendar-api
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace/calendar-api

      - name: Checkout workout-ingestor-api
        uses: actions/checkout@v4
        with:
          repository: supergeri/workout-ingestor-api
          token: ${{ secrets.GH_PAT }}
          path: amakaflow-dev-workspace/workout-ingestor-api

      - name: Write .env for dev stack
        run: |
          cat > amakaflow-dev-workspace/.env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
          CLERK_DOMAIN=${{ secrets.CLERK_DOMAIN }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          APIFY_API_TOKEN=${{ secrets.APIFY_API_TOKEN }}
          INTERNAL_API_KEY=${{ secrets.INTERNAL_API_KEY }}
          YT_TRANSCRIPT_API_TOKEN=${{ secrets.YT_TRANSCRIPT_API_TOKEN }}
          HELICONE_ENABLED=false
          TTS_ENABLED=false
          ALLOWED_ORIGINS=http://localhost:3000
          ENVIRONMENT=development
          EOF

      - name: Start dev stack
        run: |
          cd amakaflow-dev-workspace
          docker compose up -d

      - name: Wait for services
        run: bash scripts/wait-for-services.sh http://localhost:3000 http://localhost:8004/health 120 5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Playwright system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 libxcomposite1 \
            libxdamage1 libxfixes3 libxrandr2 libgbm1 \
            libxshmfence1 libpango-1.0-0 libcairo2 libasound2t64

      - name: Install Python dependencies
        run: |
          pip install -r requirements-qa.txt
          playwright install chromium

      - name: Run unit tests
        run: python3 -m pytest scripts/test_workout_import_qa.py -v

      - name: Run QA script
        id: qa
        continue-on-error: true
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        run: |
          python3 scripts/workout_import_qa.py \
            --urls fixtures/workout-qa-urls.json \
            --timeout 120

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-artifacts
          path: |
            artifacts/screenshots/
            artifacts/workout-qa-report.md
          retention-days: 7

      - name: Send Telegram report
        if: ${{ steps.qa.outputs.has_issues == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Send the markdown report
          REPORT=$(cat artifacts/workout-qa-report.md 2>/dev/null || echo "QA run completed but no report found")
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode text="${REPORT}"

          # Send each screenshot
          if ls artifacts/screenshots/*.png 1>/dev/null 2>&1; then
            for f in artifacts/screenshots/*.png; do
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto" \
                -F chat_id="${TELEGRAM_CHAT_ID}" \
                -F photo=@"$f" \
                -F caption="$(basename $f .png)"
            done
          fi

      - name: Stop dev stack
        if: always()
        run: |
          cd amakaflow-dev-workspace
          docker compose down
